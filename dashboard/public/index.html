<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Bot Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-900 text-slate-100 p-4">
  <div id="app" class="grid grid-cols-1 md:grid-cols-2 gap-4 max-w-6xl mx-auto">
    <div class="bg-slate-800/60 border border-slate-700 rounded-xl p-4">
      <h2 class="text-sky-300 text-sm font-semibold mb-2">Mood</h2>
      <div class="text-lg">{{ state.mood }}</div>
    </div>
    <div class="bg-slate-800/60 border border-slate-700 rounded-xl p-4">
      <h2 class="text-sky-300 text-sm font-semibold mb-2">Position / Vital</h2>
      <div>Pos: {{ state.bot?.position?.x }}, {{ state.bot?.position?.y }}, {{ state.bot?.position?.z }}</div>
      <div>HP: {{ state.bot?.health }} | Food: {{ state.bot?.food }}</div>
    </div>
    <div class="bg-slate-800/60 border border-slate-700 rounded-xl p-4">
      <h2 class="text-sky-300 text-sm font-semibold mb-2">Active Task</h2>
      <div v-if="state.tasks?.active">[{{ state.tasks.active.status }}] {{ state.tasks.active.title }}</div>
      <div v-else class="text-slate-400">—</div>
    </div>
    <div class="bg-slate-800/60 border border-slate-700 rounded-xl p-4">
      <h2 class="text-sky-300 text-sm font-semibold mb-2 reports">Active Build</h2>
      <div v-if="state.build">
        <div class="text-sm font-semibold mb-1">{{ state.build.name }} ({{ state.build.type }})</div>
        <div class="text-xs mb-2 text-slate-400">Material: {{ state.build.material }}</div>
        <div class="w-full bg-slate-700 rounded-full h-2 mb-1">
          <div class="bg-cyan-500 h-2 rounded-full transition-all" :style="{ width: (state.build.done / state.build.total * 100) + '%' }"></div>
        </div>
        <div class="text-xs text-slate-300">{{ state.build.done }} / {{ state.build.total }} blocks ({{ Math.floor(state.build.done / state.build.total * 100) }}%)</div>
        <div class="text-xs text-slate-400 mt-1">Origin: {{ state.build.origin.x }}, {{ state.build.origin.y }}, {{ state.build.origin.z }}</div>
      </div>
      <div v-else class="text-slate-400">—</div>
    </div>
    <div class="bg-slate-800/60 border border-slate-700 rounded-xl p-4">
      <h2 class="text-sky-300 text-sm font-semibold mb-2">Pending</h2>
      <ul class="list-disc pl-5 space-y-1">
        <li v-for="t in state.tasks?.pending" :key="t.id">[{{ t.status }}] {{ t.title }}</li>
      </ul>
    </div>
    <div class="bg-slate-800/60 border border-slate-700 rounded-xl p-4">
      <h2 class="text-sky-300 text-sm font-semibold mb-2">Completed</h2>
      <ul class="list-disc pl-5 space-y-1">
        <li v-for="t in state.tasks?.completed" :key="t.id">[{{ t.status }}] {{ t.title }}</li>
      </ul>
    </div>
    <div class="bg-slate-800/60 border border-slate-700 rounded-xl p-4">
      <h2 class="text-sky-300 text-sm font-semibold mb-2">Nearby Players</h2>
      <ul class="space-y-1">
        <li v-for="p in state.nearbyPlayers" :key="p.name">{{ p.name }} — {{ p.distance?.toFixed?.(1) ?? '—' }}m</li>
      </ul>
    </div>
    <div class="bg-slate-800/60 border border-slate-700 rounded-xl p-4">
      <h2 class="text-sky-300 text-sm font-semibold mb-2">Inventory</h2>
      <table class="w-full text-left border-separate border-spacing-y-1">
        <thead class="text-slate-300">
          <tr><th class="py-1">Item</th><th class="py-1">Count</th></tr>
        </thead>
        <tbody>
          <tr v-for="i in state.inventory" :key="i.name" class="">
            <td class="py-1">{{ i.name }}</td>
            <td class="py-1">{{ i.count }}</td>
          </tr>
        </tbody>
      </table>
    </div>
    <div class="bg-slate-800/60 border border-slate-700 rounded-xl p-4 md:col-span-2">
      <h2 class="text-sky-300 text-sm font-semibold mb-2">Function Calls</h2>
      <div class="max-h-64 overflow-y-auto space-y-2">
        <div v-if="formattedFunctionCalls.length === 0" class="text-slate-400">No function calls yet</div>
        <div v-for="(call, idx) in formattedFunctionCalls" :key="idx" class="bg-slate-700/50 rounded p-2 text-xs">
          <pre class="whitespace-pre-wrap break-words">{{ call }}</pre>
        </div>
      </div>
    </div>
    <div class="bg-slate-800/60 border border-slate-700 rounded-xl p-4 md:col-span-2">
      <h2 class="text-sky-300 text-sm font-semibold mb-2">Chat Messages</h2>
      <div class="max-h-64 overflow-y-auto space-y-2">
        <div v-if="formattedChatMessages.length === 0" class="text-slate-400">No chat messages yet</div>
        <div v-for="(msg, idx) in formattedChatMessages" :key="idx" class="bg-slate-700/50 rounded p-2 text-xs">
          <pre class="whitespace-pre-wrap break-words">{{ msg }}</pre>
        </div>
      </div>
    </div>
    <div class="bg-slate-800/60 border border-slate-700 rounded-xl p-4 md:col-span-2">
      <h2 class="text-sky-300 text-sm font-semibold mb-2">OpenAI API Calls</h2>
      <div class="max-h-96 overflow-y-auto space-y-3">
        <div v-if="!state.openAILogs || state.openAILogs.length === 0" class="text-slate-400">No API calls yet</div>
        <div v-for="(log, idx) in state.openAILogs" :key="log.id" class="bg-slate-700/50 rounded p-3 text-xs border-l-2" :class="log.type === 'periodic_think' ? 'border-cyan-500' : 'border-green-500'">
          <div class="flex justify-between items-center mb-2">
            <span class="font-semibold" :class="log.type === 'periodic_think' ? 'text-cyan-300' : 'text-green-300'">{{ log.type }}</span>
            <span class="text-slate-400">{{ log.duration }}ms</span>
          </div>
          <div class="text-slate-400 text-[10px] mb-2">{{ log.timestamp }}</div>
          
          <div class="mb-2">
            <div class="text-purple-300 font-semibold mb-1">REQUEST</div>
            <div class="pl-2 space-y-1">
              <div><span class="text-blue-300">Model:</span> {{ log.request.model }}</div>
              <div><span class="text-blue-300">Input Length:</span> {{ log.request.inputLength }} messages</div>
              <div><span class="text-blue-300">Tools:</span> {{ log.request.toolsCount }}</div>
              <div><span class="text-blue-300">Tool Choice:</span> {{ log.request.toolChoice }}</div>
              <details class="mt-1">
                <summary class="cursor-pointer text-slate-300 hover:text-slate-100">Input Preview</summary>
                <pre class="mt-1 p-2 bg-slate-800/50 rounded text-[10px] overflow-x-auto">{{ log.request.inputPreview }}</pre>
              </details>
            </div>
          </div>
          
          <div>
            <div class="text-yellow-300 font-semibold mb-1">RESPONSE</div>
            <div class="pl-2 space-y-1">
              <div><span class="text-blue-300">Tool Calls:</span> {{ log.response.toolCallsCount }}</div>
              <div v-if="log.response.textContent" class="mt-1">
                <div class="text-blue-300 mb-1">Text Content:</div>
                <div class="p-2 bg-slate-800/50 rounded text-[10px] whitespace-pre-wrap">{{ log.response.textContent }}</div>
              </div>
              <details class="mt-1">
                <summary class="cursor-pointer text-slate-300 hover:text-slate-100">Content Preview</summary>
                <pre class="mt-1 p-2 bg-slate-800/50 rounded text-[10px] overflow-x-auto">{{ log.response.contentPreview }}</pre>
              </details>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <script type="module">
    import { createApp, computed, reactive } from 'https://cdn.jsdelivr.net/npm/vue@3.4.38/dist/vue.esm-browser.prod.js';
    const state = reactive({ mood:'', build:null, tasks:{active:null,pending:[],completed:[]}, conversation:[], openAILogs:[], bot:{position:null,health:null,food:null}, inventory:[], nearbyPlayers:[] });
    const ws = new WebSocket(`ws://${location.host}/ws`);
    ws.onmessage = (e)=>{ try{ const msg = JSON.parse(e.data); if(msg.type==='state'){ Object.assign(state, msg.payload); } }catch{} };
    createApp({
      setup(){
        const formattedFunctionCalls = computed(() => {
          return state.conversation
            .filter(c => {
              const content = typeof c.content === 'string' ? c.content : JSON.stringify(c.content);
              return content.includes('Executed tool') || c.role === 'system';
            })
            .map(c => `[${c.role}] ${typeof c.content === 'string' ? c.content : JSON.stringify(c.content)}`);
        });
        
        const formattedChatMessages = computed(() => {
          return state.conversation
            .filter(c => {
              const content = typeof c.content === 'string' ? c.content : JSON.stringify(c.content);
              return !content.includes('Executed tool') && c.role !== 'system';
            })
            .map(c => `[${c.role}] ${typeof c.content === 'string' ? c.content : JSON.stringify(c.content)}`);
        });
        
        return { state, formattedFunctionCalls, formattedChatMessages };
      }
    }).mount('#app');
  </script>
</body>
</html>


